name: Build, Test and Deploy

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3
        with:
          install-compose: true

      - name: Create .env file from secrets
        run: |
          DB_NAME=${{ secrets.DB_NAME || 'taskmanager' }}
          DB_USER=${{ secrets.DB_USER || 'postgres' }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_CONNECTION_STRING=${{ secrets.DB_CONNECTION_STRING || 'Host=db;Port=5432;Database=taskmanager;Username=postgres;Password=${DB_PASSWORD}' }}
          
          # PgAdmin
          PGADMIN_EMAIL=${{ secrets.PGADMIN_EMAIL || 'admin@example.com' }}
          PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}


      - name: Build with Docker Compose
        run: docker compose build

      - name: Test services start correctly
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ .env Ñ„Ð°Ð¹Ð»Ð¾Ð¼
          docker compose up -d
          sleep 30
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          docker compose ps
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð±ÑÐºÐµÐ½Ð´Ð° (Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ)
          echo "Checking backend logs for DB connection..."
          docker compose logs auth --tail=20
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoints
          echo "Testing backend..."
          curl -f http://localhost:15378/health || echo "Backend health check failed"
          
          echo "Testing frontend..."
          curl -f http://localhost:14000 || echo "Frontend check failed"
          
          docker compose down

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          envs: |
            DB_NAME
            DB_PASSWORD
            BACKEND_SECRET_KEY
          script: |
            echo "ðŸš€ Starting deployment..."
            cd ${{ secrets.SERVER_PATH }}
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
            cat > .env << EOF
            # Database
            DB_NAME=${{ secrets.DB_NAME || 'taskmanager' }}
            DB_USER=${{ secrets.DB_USER || 'postgres' }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_CONNECTION_STRING=Host=db;Port=5432;Database=$${DB_NAME};Username=$${DB_USER};Password=$${DB_PASSWORD}
            
            # PgAdmin
            PGADMIN_EMAIL=${{ secrets.PGADMIN_EMAIL || 'admin@example.com' }}
            PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
            
            # Backend
            BACKEND_SECRET_KEY=${{ secrets.BACKEND_SECRET_KEY }}
            
            # Frontend
            FRONTEND_API_URL=${{ secrets.FRONTEND_API_URL || 'http://localhost:15378' }}
            EOF
            
            echo "Pulling latest code..."
            git pull origin main
            
            echo "Stopping old containers..."
            docker compose down
            
            echo "Building new containers..."
            docker compose build --no-cache
            
            echo "Starting containers..."
            docker compose up -d
            
            echo "Checking containers..."
            sleep 10
            docker compose ps
            
            echo "Checking backend logs..."
            docker compose logs auth --tail=10
            
            echo "âœ… Deployment completed!"