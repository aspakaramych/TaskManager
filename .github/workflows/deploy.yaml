name: Build, Test and Deploy

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  # –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö jobs
  COMPOSE_PROJECT_NAME: app-ci-${{ github.run_id }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    outputs:
      all_secrets_set: ${{ steps.check-secrets.outputs.all_set }}

    steps:
      - name: Check all required secrets are set
        id: check-secrets
        run: |
          ALL_SET="true"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
          if [ -z "${{ secrets.DB_CONNECTION_STRING }}" ]; then
            echo "‚ùå DB_CONNECTION_STRING is not set"
            ALL_SET="false"
          else
            echo "‚úÖ DB_CONNECTION_STRING is set"
          fi
          
          if [ -z "${{ secrets.DB_NAME }}" ]; then
            echo "‚ùå DB_NAME is not set"
            ALL_SET="false"
          else
            echo "‚úÖ DB_NAME is set"
          fi
          
          if [ -z "${{ secrets.DB_USER }}" ]; then
            echo "‚ùå DB_USER is not set"
            ALL_SET="false"
          else
            echo "‚úÖ DB_USER is set"
          fi
          
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "‚ùå DB_PASSWORD is not set"
            ALL_SET="false"
          else
            echo "‚úÖ DB_PASSWORD is set"
          fi
          
          if [ -z "${{ secrets.PGADMIN_EMAIL }}" ]; then
            echo "‚ùå PGADMIN_EMAIL is not set"
            ALL_SET="false"
          else
            echo "‚úÖ PGADMIN_EMAIL is set"
          fi
          
          if [ -z "${{ secrets.PGADMIN_PASSWORD }}" ]; then
            echo "‚ùå PGADMIN_PASSWORD is not set"
            ALL_SET="false"
          else
            echo "‚úÖ PGADMIN_PASSWORD is set"
          fi
          
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "‚ùå SERVER_HOST is not set"
            ALL_SET="false"
          else
            echo "‚úÖ SERVER_HOST is set"
          fi
          
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "‚ùå SERVER_USER is not set"
            ALL_SET="false"
          else
            echo "‚úÖ SERVER_USER is set"
          fi
          
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY is not set"
            ALL_SET="false"
          else
            echo "‚úÖ SSH_PRIVATE_KEY is set"
          fi
          
          echo "all_set=$ALL_SET" >> $GITHUB_OUTPUT

      - name: Test SSH connection (if secrets are set)
        if: steps.check-secrets.outputs.all_set == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            echo "‚úÖ SSH connection test successful!"
            echo "Server: $(hostname)"
            echo "User: $(whoami)"
            echo "Date: $(date)"

  build-and-test:
    needs: verify-secrets
    if: needs.verify-secrets.outputs.all_secrets_set == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Setup Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-v1 || sudo apt-get install -y docker-compose

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          # Database configuration
          DB_CONNECTION_STRING=${{ secrets.DB_CONNECTION_STRING }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # PgAdmin configuration
          PGADMIN_EMAIL=${{ secrets.PGADMIN_EMAIL }}
          PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
          
          # Application ports
          BACKEND_PORT=15378
          FRONTEND_PORT=14000
          POSTGRES_PORT=5432
          PGADMIN_PORT=5050
          EOF
          
          echo "‚úÖ Created .env file for testing"
          echo "File content (secrets masked):"
          sed 's/=.*/=***/' .env

      - name: Build with Docker Compose
        run: docker compose build

      - name: Test services start correctly
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "Starting containers..."
          docker compose up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          echo "Waiting for services to start..."
          sleep 30
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "Container status:"
          docker compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã
          SERVICES=$(docker compose ps --services)
          echo "Services: $SERVICES"
          
          for service in $SERVICES; do
            if docker compose ps $service | grep -q "Up"; then
              echo "‚úÖ $service is running"
            else
              echo "‚ùå $service is NOT running"
              docker compose logs $service
            fi
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoints
          echo "Testing application health..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ç–∫–µ–Ω–¥
          if curl -s -f http://localhost:15378/health > /dev/null 2>&1; then
            echo "‚úÖ Backend is healthy"
          else
            echo "‚ö†Ô∏è Backend health check failed"
            docker compose logs backend || true
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
          if curl -s -f http://localhost:14000 > /dev/null 2>&1; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ö†Ô∏è Frontend check failed"
            docker compose logs frontend || true
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker compose down
          echo "‚úÖ Test completed"

  deploy:
    needs: [verify-secrets, build-and-test]
    if: |
      needs.verify-secrets.outputs.all_secrets_set == 'true' &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            echo "üöÄ Starting deployment..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd ${{ secrets.SERVER_PATH }}
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "Pulling latest code..."
            git pull origin main
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Stopping old containers..."
            docker-compose down || echo "No running containers found"
            
            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
            echo "Creating .env file..."
            cat > .env << 'EOF'
            # Database configuration
            DB_CONNECTION_STRING=${{ secrets.DB_CONNECTION_STRING }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            # PgAdmin configuration
            PGADMIN_EMAIL=${{ secrets.PGADMIN_EMAIL }}
            PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
            EOF
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∞–≤–∞
            chmod 600 .env
            
            echo "Environment variables set:"
            echo "DB_CONNECTION_STRING: $(echo ${{ secrets.DB_CONNECTION_STRING }} | cut -c1-10)..."
            echo "DB_NAME: ${{ secrets.DB_NAME }}"
            echo "DB_USER: ${{ secrets.DB_USER }}"
            echo "DB_PASSWORD: ***"
            echo "PGADMIN_EMAIL: ${{ secrets.PGADMIN_EMAIL }}"
            echo "PGADMIN_PASSWORD: ***"
            
            # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Building new containers..."
            docker-compose build --no-cache
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Starting containers..."
            docker-compose up -d
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            echo "Waiting for services to start..."
            sleep 20
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "Container status:"
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "Checking service health..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ç–∫–µ–Ω–¥
            if curl -s -f http://localhost:15378/health > /dev/null; then
              echo "‚úÖ Backend is healthy"
            else
              echo "‚ö†Ô∏è Backend health check failed"
              docker-compose logs backend --tail=50
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if curl -s -f http://localhost:14000 > /dev/null; then
              echo "‚úÖ Frontend is accessible"
            else
              echo "‚ö†Ô∏è Frontend check failed"
              docker-compose logs frontend --tail=50
            fi
            
            # –û—á–∏—Å—Ç–∫–∞
            echo "Cleaning up old Docker resources..."
            docker system prune -f --volumes || true
            
            echo "‚úÖ Deployment completed successfully!"