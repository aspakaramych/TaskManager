name: Build, Test and Deploy

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  COMPOSE_PROJECT_NAME: app-ci-${{ github.run_id }}

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    outputs:
      ssh_available: ${{ steps.test-ssh.outputs.available }}

    steps:
      - name: Test SSH connection
        id: test-ssh
        continue-on-error: true
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è —Ç–µ—Å—Ç–∞
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          # –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
          if ssh -o StrictHostKeyChecking=no -i /tmp/ssh_key \
             ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
             -p ${{ secrets.SSH_PORT || '22' }} \
             "echo 'SSH connection successful'"; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  build-and-test:
    runs-on: ubuntu-latest
    # –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç—ã

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Setup Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-v1 || sudo apt-get install -y docker-compose

      - name: Build with Docker Compose
        run: docker compose build

      - name: Test services start correctly
        run: |
          echo "Starting containers for testing..."
          docker compose up -d
          
          echo "Waiting for services to start..."
          sleep 30
          
          echo "Container status:"
          docker compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã
          SERVICES=$(docker compose ps --services)
          echo "Testing services: $SERVICES"
          
          ALL_RUNNING=true
          for service in $SERVICES; do
            if docker compose ps $service | grep -q "Up"; then
              echo "‚úÖ $service is running"
            else
              echo "‚ùå $service is NOT running"
              docker compose logs $service --tail=20
              ALL_RUNNING=false
            fi
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoints –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã
          if [ "$ALL_RUNNING" = true ]; then
            echo "Testing application health..."
          
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ç–∫–µ–Ω–¥
            if curl -s -f http://localhost:15378/health > /dev/null 2>&1; then
              echo "‚úÖ Backend health check passed"
            else
              echo "‚ö†Ô∏è Backend health check failed, but service is running"
              docker compose logs backend --tail=10 || true
            fi
          
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if curl -s -f http://localhost:14000 > /dev/null 2>&1; then
              echo "‚úÖ Frontend is accessible"
            else
              echo "‚ö†Ô∏è Frontend check failed, but service is running"
              docker compose logs frontend --tail=10 || true
            fi
          else
            echo "‚ö†Ô∏è Some services failed to start, skipping health checks"
          fi
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏
          echo "Saving logs before cleanup..."
          docker compose logs --no-color > docker-compose.logs 2>&1 || true
          
          echo "Cleaning up..."
          docker compose down -v
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          if [ "$ALL_RUNNING" = false ]; then
            echo "::warning::Some services failed to start"
          fi
          
          echo "‚úÖ Test completed"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: docker-compose-logs
          path: docker-compose.logs

  deploy:
    needs: [verify-secrets, build-and-test]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            echo "üöÄ Starting deployment..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd ${{ secrets.SERVER_PATH }}
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "Pulling latest code..."
            git pull origin main
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Stopping old containers..."
            docker-compose down || echo "No running containers found"
            
            # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Building new containers..."
            docker-compose build
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Starting containers..."
            docker-compose up -d
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
            echo "Waiting for services to start..."
            sleep 20
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "Container status:"
            docker-compose ps
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "Checking service health..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ç–∫–µ–Ω–¥
            if curl -s -f http://localhost:15378/health > /dev/null; then
              echo "‚úÖ Backend is healthy"
            else
              echo "‚ö†Ô∏è Backend health check failed"
              docker-compose logs backend --tail=50
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if curl -s -f http://localhost:14000 > /dev/null; then
              echo "‚úÖ Frontend is accessible"
            else
              echo "‚ö†Ô∏è Frontend check failed"
              docker-compose logs frontend --tail=50
            fi
            
            # –û—á–∏—Å—Ç–∫–∞
            echo "Cleaning up old Docker resources..."
            docker system prune -f || true
            
            echo "‚úÖ Deployment completed successfully!"