name: Build, Test and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker with Compose
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose Plugin
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker Compose ÐºÐ°Ðº Ð¿Ð»Ð°Ð³Ð¸Ð½ (docker compose Ñ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð¼)
          mkdir -p ~/.docker/cli-plugins
          curl -sSL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
          chmod +x ~/.docker/cli-plugins/docker-compose
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² PATH Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
          echo "$HOME/.docker/cli-plugins" >> $GITHUB_PATH
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ
          docker compose version

      - name: Build with Docker Compose
        run: |
          docker compose version
          docker compose build

      - name: Test services start correctly
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          docker compose up -d
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          sleep 30
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          docker compose ps
          
          # Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          RUNNING_COUNT=$(docker compose ps --services --filter "status=running" | wc -l)
          echo "Running services: $RUNNING_COUNT"
          
          if [ $RUNNING_COUNT -lt 2 ]; then
            echo "âŒ Not all services are running"
            docker compose logs
            exit 1
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoints
          echo "Testing backend health..."
          curl -f http://localhost:15378/health || echo "âš ï¸ Backend health check failed (but container is running)"
          
          echo "Testing frontend..."
          curl -f http://localhost:14000 || echo "âš ï¸ Frontend check failed (but container is running)"
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼
          docker compose down

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            echo "ðŸš€ Starting deployment..."
            cd ${{ secrets.SERVER_PATH }}
            
            echo "Pulling latest code..."
            git pull origin main
            
            echo "Stopping old containers..."
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°ÐºÐ°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
            if command -v docker-compose &> /dev/null; then
              echo "Using docker-compose (with hyphen)"
              COMPOSE_CMD="docker-compose"
            else
              echo "Using docker compose (with space)"
              COMPOSE_CMD="docker compose"
            fi
            
            $COMPOSE_CMD down
            
            echo "Building new containers..."
            $COMPOSE_CMD build --no-cache
            
            echo "Starting containers..."
            $COMPOSE_CMD up -d
            
            echo "Cleaning up..."
            docker system prune -f
            
            echo "âœ… Deployment completed!"
            $COMPOSE_CMD ps