name: Build, Test and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3
        with:
          install-compose: true

      - name: Build with Docker Compose
        run: docker compose build

      - name: Test services start correctly
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker compose up -d
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 30
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          docker compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—É—â–µ–Ω—ã
          RUNNING_COUNT=$(docker compose ps | grep "Up" | wc -l)
          echo "Running containers: $RUNNING_COUNT"
          
          if [ $RUNNING_COUNT -lt 2 ]; then
            echo "‚ùå Not all services are running"
            docker compose logs
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoints
          echo "Testing backend health..."
          curl -f http://localhost:15378/health || echo "‚ö†Ô∏è Backend health check failed"
          
          echo "Testing frontend..."
          curl -f http://localhost:14000 || echo "‚ö†Ô∏è Frontend check failed"
          
          docker compose down

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          # üí° –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤
          env:
            POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
            PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}
          # üí° –ò–∑–º–µ–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã
          script: |
            echo "üöÄ Starting deployment..."
            cd ${{ secrets.SERVER_PATH }}
            
            echo "Pulling latest code..."
            git pull origin main
            
            echo "Stopping old containers..."
            docker-compose down
            
            echo "Building new containers..."
            docker-compose build --no-cache
            
            echo "Starting containers..."
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º $POSTGRES_PASSWORD –∏ $PGADMIN_PASSWORD, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `env:` –≤—ã—à–µ
            POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
            PGADMIN_PASSWORD="$PGADMIN_PASSWORD" \
            docker-compose up -d
            
            echo "Cleaning up..."
            docker system prune -f
            
            echo "‚úÖ Deployment completed!"
            docker-compose ps