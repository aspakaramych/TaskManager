name: Build, Test and Deploy

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  # ÐžÐ±Ñ‰Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð²ÑÐµÑ… jobs
  COMPOSE_PROJECT_NAME: app-ci-${{ github.run_id }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Setup Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-v1 || sudo apt-get install -y docker-compose

      - name: Build with Docker Compose
        run: docker compose build

      - name: Test services start correctly
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          docker compose up -d
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸
          echo "Waiting for services to start..."
          timeout 60 bash -c 'until docker compose ps | grep -q "Up"; do sleep 2; done'
          
          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ð°ÑƒÐ·Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          sleep 10
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          echo "Container status:"
          docker compose ps
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¾Ð±Ð° ÑÐµÑ€Ð²Ð¸ÑÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹
          RUNNING_COUNT=$(docker compose ps --services | xargs -I {} sh -c 'docker compose ps {} | grep -q "Up" && echo 1' | wc -l)
          SERVICE_COUNT=$(docker compose ps --services | wc -l)
          echo "Running containers: $RUNNING_COUNT/$SERVICE_COUNT"
          
          if [ $RUNNING_COUNT -lt $SERVICE_COUNT ]; then
            echo "âŒ Not all services are running"
            docker compose logs
            exit 1
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoints Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸
          echo "Testing backend health..."
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if curl -f http://localhost:15378/health 2>/dev/null; then
              echo "âœ… Backend is healthy"
              break
            fi
            echo "Attempt $attempt failed, retrying..."
            sleep 5
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âš ï¸ Backend health check failed after $max_attempts attempts"
          fi
          
          echo "Testing frontend..."
          if curl -f http://localhost:14000 2>/dev/null; then
            echo "âœ… Frontend is accessible"
          else
            echo "âš ï¸ Frontend check failed"
          fi
          
          docker compose down

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script_stop: true
          script: |
            echo "ðŸš€ Starting deployment..."
            cd ${{ secrets.SERVER_PATH }}
            
            echo "Pulling latest code..."
            git pull origin main
            
            echo "Stopping old containers..."
            docker-compose down || true
            
            echo "Creating .env file from secrets..."
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
            cat > .env << EOF
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
            EOF
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            chmod 600 .env
            
            echo "Building new containers..."
            docker-compose build --no-cache
            
            echo "Starting containers..."
            docker-compose up -d
            
            echo "Cleaning up..."
            docker system prune -f --volumes
            
            echo "âœ… Deployment completed!"
            echo "Container status:"
            docker-compose ps